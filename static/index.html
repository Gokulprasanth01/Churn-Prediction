<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Churn Prediction</title>
    <script>
        async function fetchDatasets() {
            const response = await fetch('/datasets/');
            const data = await response.json();
            const datasets = data.datasets;

            const datasetSelect = document.getElementById('dataset');
            datasetSelect.innerHTML = '<option value="">Select a dataset</option>';
            datasets.forEach(dataset => {
                datasetSelect.innerHTML += `<option value="${dataset}">${dataset}</option>`;
            });
        }

        async function fetchColumns() {
            const datasetName = document.getElementById('dataset').value;
            if (!datasetName) return;

            const response = await fetch(`/datasets/${datasetName}`);
            const data = await response.json();
            const columns = data.columns;

            const form = document.getElementById('data-form');
            form.innerHTML = '';

            columns.forEach(column => {
                if (column !== 'churn') {
                    form.innerHTML += `<label for="${column}">${column}:</label><input type="text" id="${column}" name="${column}"><br>`;
                }
            });
        }

        async function fetchModels() {
            const response = await fetch('/models/');
            const data = await response.json();
            const models = data.models;

            const modelSelect = document.getElementById('model');
            modelSelect.innerHTML = '<option value="">Select a model</option>';
            models.forEach(model => {
                modelSelect.innerHTML += `<option value="${model}">${model}</option>`;
            });
        }

        async function trainModel() {
            const dataset = document.getElementById('dataset').value;
            if (!dataset) {
                alert('Please select a dataset.');
                return;
            }

            const response = await fetch('/train/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ dataset_name: dataset })
            });

            const result = await response.json();
            alert(result.message);
        }

        async function predictChurn() {
            const dataset = document.getElementById('dataset').value;
            const model = document.getElementById('model').value;
            if (!dataset || !model) {
                alert('Please select a dataset and model.');
                return;
            }

            const formData = new FormData(document.getElementById('data-form'));
            const data = {};
            formData.forEach((value, key) => {
                data[key] = value;
            });

            const response = await fetch('/predict/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ dataset_name: dataset, model_name: model, data: data })
            });

            const result = await response.json();
            alert(`Prediction: ${result.prediction}, Probability: ${result.probability}`);
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchDatasets();
            fetchModels();
        });
    </script>
</head>
<body>
    <h1>Churn Prediction</h1>
    
    <h2>Train Model</h2>
    <label for="dataset">Dataset:</label>
    <select id="dataset" name="dataset" onchange="fetchColumns()">
        <option value="">Select a dataset</option>
    </select><br>
    
    <button onclick="trainModel()">Train Model</button>

    <h2>Predict Churn</h2>
    <label for="dataset">Dataset:</label>
    <select id="dataset" name="dataset" onchange="fetchColumns()">
        <option value="">Select a dataset</option>
    </select><br>
    
    <label for="model">Model:</label>
    <select id="model" name="model">
        <option value="">Select a model</option>
    </select><br>

    <form id="data-form"></form>

    <button onclick="predictChurn()">Predict</button>
</body>
</html>
